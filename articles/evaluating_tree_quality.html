<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluating Tree Quality • sctree</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Evaluating Tree Quality">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sctree</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/antibody_query.html">Query Antibody vendors from inside R</a>
    </li>
    <li>
      <a href="../articles/evaluating_tree_quality.html">Evaluating Tree Quality</a>
    </li>
    <li>
      <a href="../articles/plot_flowstyle.html">Flow style plotting</a>
    </li>
    <li>
      <a href="../articles/sctree/sctree.html">sctree</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Evaluating Tree Quality</h1>
            
      
      
      <div class="hidden name"><code>evaluating_tree_quality.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sctree)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co">#&gt; Loading required package: Seurat</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">#&gt; Registered S3 method overwritten by 'GGally':</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">#&gt;   method from   </span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">#&gt;   +.gg   ggplot2</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#&gt; Attaching package: 'sctree'</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#&gt; The following objects are masked from 'package:Seurat':</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">#&gt;     FindAllMarkers, FindConservedMarkers, FindMarkers</span></a></code></pre></div>
<p>Testing the quality of the generated classifiers has three main parts.</p>
<ol style="list-style-type: decimal">
<li>Splitting the data that wants to be classified in two.</li>
<li>Use one of the splits to train the classifier.</li>
<li>Use the model on the rest of the data and check the accuracy.</li>
</ol>
<p>To illustrate the process, we will use this tiny dataset that comes bundled with our package. Additional information can be obtained by using <code><a href="../reference/small_5050_mix.html">?small_5050_mix</a></code></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">DimPlot</span>(small_<span class="dv">5050</span>_mix)</a></code></pre></div>
<p><img src="evaluating_tree_quality_files/figure-html/unnamed-chunk-2-1.png" width="384"></p>
<div id="splitting-the-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#splitting-the-dataset" class="anchor"></a>Splitting the dataset</h2>
<p>There are several ways in which this can be done, here we will sample 80% of the cells for the training, this will be don using Seurat’s <code>subset</code> interface.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co"># Here we get the names of all cells</span></a>
<a class="sourceLine" id="cb3-2" title="2">all_cells &lt;-<span class="st"> </span><span class="kw">Cells</span>(small_<span class="dv">5050</span>_mix)</a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co"># Here we get what number of cells would be 80%</span></a>
<a class="sourceLine" id="cb3-5" title="5">num_cells_train &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fl">0.8</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(all_cells))</a>
<a class="sourceLine" id="cb3-6" title="6">num_cells_train</a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; [1] 204</span></a></code></pre></div>
<p>Sample will select 204 cell names and store those names in <code>cells_train</code>, we will also store all other names in <code>cells_test</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"></a>
<a class="sourceLine" id="cb4-2" title="2">cells_train &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(all_cells, num_cells_train)</a>
<a class="sourceLine" id="cb4-3" title="3">cells_test &lt;-<span class="st"> </span>all_cells[<span class="op">!</span>all_cells <span class="op">%in%</span><span class="st"> </span>cells_train]</a></code></pre></div>
<p>Now using the subset operation, we get two Seurat objects containing each of the correspoinding cells.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">training_mix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(small_<span class="dv">5050</span>_mix, <span class="dt">cells =</span> cells_train)</a>
<a class="sourceLine" id="cb5-2" title="2">testing_mix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(small_<span class="dv">5050</span>_mix, <span class="dt">cells =</span> cells_test)</a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4">training_mix</a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co">#&gt; An object of class Seurat </span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="co">#&gt; 1031 features across 204 samples within 1 assay </span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">#&gt; Active assay: RNA (1031 features)</span></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">#&gt;  2 dimensional reductions calculated: pca, tsne</span></a>
<a class="sourceLine" id="cb5-9" title="9">testing_mix</a>
<a class="sourceLine" id="cb5-10" title="10"><span class="co">#&gt; An object of class Seurat </span></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="co">#&gt; 1031 features across 51 samples within 1 assay </span></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="co">#&gt; Active assay: RNA (1031 features)</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="co">#&gt;  2 dimensional reductions calculated: pca, tsne</span></a></code></pre></div>
</div>
<div id="trainning-the-classifier" class="section level2">
<h2 class="hasAnchor">
<a href="#trainning-the-classifier" class="anchor"></a>Trainning the classifier</h2>
<p>Once the training subset has been defined, we can proceed to generate our classification tree using <code>fit_ctree</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">tree_model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_ctree.html">fit_ctree</a></span>(training_mix)</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="../reference/as.garnett.html">as.garnett</a></span>(tree_model))</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#&gt; &gt; 0_node_3   (n = 26)</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">#&gt; expressed below: CD3D 3.124, HEY1 1.924</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#&gt; &gt; 0_node_6   (n = 109)</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt; expressed above: CD3D 3.124</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#&gt; expressed below: TSC22D3 2.121</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#&gt; &gt; 0_node_7   (n = 13)</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#&gt; expressed above: CD3D 3.124, TSC22D3 2.121</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#&gt; &gt; 1  (n = 56)</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">#&gt; expressed above: HEY1 1.924</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co">#&gt; expressed below: CD3D 3.124</span></a></code></pre></div>
</div>
<div id="checking-the-consistency-of-the-classifier" class="section level2">
<h2 class="hasAnchor">
<a href="#checking-the-consistency-of-the-classifier" class="anchor"></a>Checking the consistency of the classifier</h2>
<p>This model can now be used to generate a prediction on the testing data. For this we will use the <code>predict</code> generic, which requires the new data to be passed as a <code>data.frame</code>.</p>
<p>We can store these predictions in the Seurat object itself for future usage.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">predicted_cluster &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(</a>
<a class="sourceLine" id="cb7-2" title="2">    tree_model, </a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="dt">newdata =</span> <span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(testing_mix))</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5">testing_mix[[<span class="st">"predicted_cluster"</span>]] &lt;-<span class="st"> </span>predicted_cluster</a>
<a class="sourceLine" id="cb7-6" title="6">testing_mix[[<span class="st">"correctly_classified"</span>]] &lt;-<span class="st"> </span>predicted_cluster <span class="op">==</span><span class="st"> </span><span class="kw">Idents</span>(testing_mix)</a></code></pre></div>
<p>Furthermore, we can generate a confusion matrix based on the classifications by passing the data onto <code>table</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">confusion_tbl &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(</a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="dt">Predicted =</span> predicted_cluster, </a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="dt">Actual =</span> <span class="kw">Idents</span>(testing_mix))</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">confusion_tbl</a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">#&gt;          Actual</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">#&gt; Predicted  0  1</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">#&gt;         0 29  3</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">#&gt;         1  8 11</span></a>
<a class="sourceLine" id="cb8-10" title="10"></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co"># We can convert these absolute numbers to percentages</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="kw"><a href="../reference/as.frequency.matrix.html">as.frequency.matrix</a></span>(confusion_tbl)</a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">#&gt;          Actual</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">#&gt; Predicted        0        1</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">#&gt;         0 78.37838 21.42857</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co">#&gt;         1 21.62162 78.57143</span></a></code></pre></div>
<p>We can also display graphically this information using <code>autoplot</code></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="../reference/autoplot.html">autoplot</a></span>(<span class="kw"><a href="../reference/as.frequency.matrix.html">as.frequency.matrix</a></span>(confusion_tbl), <span class="dt">show_number =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="evaluating_tree_quality_files/figure-html/unnamed-chunk-9-1.png" width="288"></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">DimPlot</span>(testing_mix, <span class="dt">group.by =</span> <span class="st">"correctly_classified"</span>)</a></code></pre></div>
<p><img src="evaluating_tree_quality_files/figure-html/unnamed-chunk-10-1.png" width="384"></p>
</div>
<div id="tuning-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#tuning-the-model" class="anchor"></a>Tuning the model</h2>
<p>I is posible to modify how the model is generated, in this case, we might want to define the markers based on some previous information or some quality metric. Here we will use the top 6 genes according to a random-forest based importance metric.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">markers &lt;-<span class="st"> </span><span class="kw"><a href="../reference/FindAllMarkers.html">FindAllMarkers</a></span>(</a>
<a class="sourceLine" id="cb11-2" title="2">    training_mix, <span class="dt">test.use =</span> <span class="st">"RangerDE"</span>,</a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="dt">only.pos =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb11-4" title="4">    <span class="dt">warn.imp.method =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">#&gt; Calculating cluster 0</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="co">#&gt; Calculating cluster 1</span></a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(markers)</a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">#&gt;       importance p_val  gene avg_logFC pct.1 pct.2 p_val_adj cluster</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">#&gt; MZB1   2.2142543     0  MZB1  1.909216 0.832 0.230         0       0</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">#&gt; CD3D   3.1634060     0  CD3D  1.783060 0.881 0.377         0       0</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">#&gt; ITGA4  0.6338057     0 ITGA4  1.780135 0.594 0.066         0       0</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#&gt; FYB    0.5491506     0   FYB  1.747208 0.741 0.115         0       0</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#&gt; CD3G   0.9445293     0  CD3G  1.732194 0.748 0.131         0       0</span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">#&gt; ADA    2.4258305     0   ADA  1.704872 0.930 0.541         0       0</span></a>
<a class="sourceLine" id="cb11-16" title="16"></a>
<a class="sourceLine" id="cb11-17" title="17">importance_cutoff &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(markers<span class="op">$</span>importance, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)[<span class="dv">6</span>]</a>
<a class="sourceLine" id="cb11-18" title="18">top_markers &lt;-<span class="st"> </span>markers[markers<span class="op">$</span>importance <span class="op">&gt;</span><span class="st"> </span>importance_cutoff,]</a>
<a class="sourceLine" id="cb11-19" title="19">top_markers</a>
<a class="sourceLine" id="cb11-20" title="20"><span class="co">#&gt;         importance p_val    gene avg_logFC pct.1 pct.2 p_val_adj cluster</span></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="co">#&gt; CD3D      3.163406     0    CD3D  1.783060 0.881 0.377         0       0</span></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="co">#&gt; ARHGDIB   3.147184     0 ARHGDIB  1.694954 0.860 0.344         0       0</span></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="co">#&gt; TMSB4X    3.722523     0  TMSB4X  1.632897 0.951 0.820         0       0</span></a>
<a class="sourceLine" id="cb11-24" title="24"><span class="co">#&gt; CKB       8.272143     0     CKB  1.252858 1.000 0.657         0       1</span></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="co">#&gt; NDFIP2    2.865956     0  NDFIP2  1.022000 0.869 0.273         0       1</span></a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw"><a href="../reference/plot_flowstyle.html">plot_flowstyle</a></span>(</a>
<a class="sourceLine" id="cb12-2" title="2">    <span class="dt">object =</span> training_mix, </a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="dt">markernames =</span> top_markers<span class="op">$</span>gene, </a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="dt">highlight_class =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="evaluating_tree_quality_files/figure-html/unnamed-chunk-12-1.png" width="480"></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="kw"><a href="../reference/plot_flowstyle.html">plot_flowstyle</a></span>(</a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="dt">object =</span> testing_mix, </a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="dt">markernames =</span> top_markers<span class="op">$</span>gene, </a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="dt">highlight_class =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="evaluating_tree_quality_files/figure-html/unnamed-chunk-12-2.png" width="480"></p>
<p>We can pass to <code>fit_ctree</code> any parameter accepted by <code><a href="https://rdrr.io/pkg/partykit/man/ctree_control.html">?partykit::ctree_control</a></code>. Some of the parameters that might affect the most the final tree would be:</p>
<ul>
<li>
<code>alpha</code>, which would modify the splitting criteria, values close to 1 indicate that more splits could be considered.</li>
<li>
<code>maxdepth</code>, which specifies how deep can the tree be.</li>
<li>
<code>minbucket</code>, which specifies how many cells can each terminal node have.</li>
<li>
<code>minsplit</code>, specifies how small can a node be to be considered for further splitting.</li>
</ul>
<p>Please note that more complicated classifiers will usually have better classification performance, but less interpretability. Nontheless, there will be point in which the classifier gets better within the training data but will not improve in the testing data (phenomenom called over-fitting the model).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">tree_model_topn &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_ctree.html">fit_ctree</a></span>(</a>
<a class="sourceLine" id="cb14-2" title="2">    training_mix,</a>
<a class="sourceLine" id="cb14-3" title="3">    <span class="dt">genes_use =</span> top_markers<span class="op">$</span>gene,</a>
<a class="sourceLine" id="cb14-4" title="4">    <span class="dt">alpha =</span> <span class="fl">0.99</span>, <span class="dt">minbucket =</span> <span class="dv">2</span>, <span class="dt">minsplit =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-5" title="5"></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="../reference/as.garnett.html">as.garnett</a></span>(tree_model_topn))</a>
<a class="sourceLine" id="cb14-7" title="7"><span class="co">#&gt; &gt; 0_node_14  (n = 4)</span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="co">#&gt; expressed below: ARHGDIB 0, CD3D 3.124, NDFIP2 0, TMSB4X 0</span></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="co">#&gt; expressed between: CKB 5.142 4.539</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-11" title="11"><span class="co">#&gt; &gt; 0_node_15  (n = 4)</span></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="co">#&gt; expressed above: TMSB4X 0</span></a>
<a class="sourceLine" id="cb14-13" title="13"><span class="co">#&gt; expressed below: ARHGDIB 0, CD3D 3.124, NDFIP2 0</span></a>
<a class="sourceLine" id="cb14-14" title="14"><span class="co">#&gt; expressed between: CKB 5.142 4.539</span></a>
<a class="sourceLine" id="cb14-15" title="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-16" title="16"><span class="co">#&gt; &gt; 0_node_24  (n = 2)</span></a>
<a class="sourceLine" id="cb14-17" title="17"><span class="co">#&gt; expressed below: CD3D 1.741</span></a>
<a class="sourceLine" id="cb14-18" title="18"><span class="co">#&gt; expressed between: CKB 4.848 4.803, NDFIP2 2.215 0</span></a>
<a class="sourceLine" id="cb14-19" title="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-20" title="20"><span class="co">#&gt; &gt; 0_node_28  (n = 2)</span></a>
<a class="sourceLine" id="cb14-21" title="21"><span class="co">#&gt; expressed above: CKB 4.539</span></a>
<a class="sourceLine" id="cb14-22" title="22"><span class="co">#&gt; expressed below: TMSB4X 0</span></a>
<a class="sourceLine" id="cb14-23" title="23"><span class="co">#&gt; expressed between: CD3D 3.124 1.741, NDFIP2 2.841 0</span></a>
<a class="sourceLine" id="cb14-24" title="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-25" title="25"><span class="co">#&gt; &gt; 0_node_31  (n = 2)</span></a>
<a class="sourceLine" id="cb14-26" title="26"><span class="co">#&gt; expressed above: CKB 5.031, TMSB4X 0</span></a>
<a class="sourceLine" id="cb14-27" title="27"><span class="co">#&gt; expressed between: CD3D 3.124 1.741, NDFIP2 2.841 0</span></a>
<a class="sourceLine" id="cb14-28" title="28"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-29" title="29"><span class="co">#&gt; &gt; 0_node_32  (n = 5)</span></a>
<a class="sourceLine" id="cb14-30" title="30"><span class="co">#&gt; expressed above: CKB 4.539, NDFIP2 2.841</span></a>
<a class="sourceLine" id="cb14-31" title="31"><span class="co">#&gt; expressed below: CD3D 3.124</span></a>
<a class="sourceLine" id="cb14-32" title="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-33" title="33"><span class="co">#&gt; &gt; 0_node_36  (n = 102)</span></a>
<a class="sourceLine" id="cb14-34" title="34"><span class="co">#&gt; expressed above: CD3D 3.124</span></a>
<a class="sourceLine" id="cb14-35" title="35"><span class="co">#&gt; expressed below: NDFIP2 1.588, TMSB4X 5.7</span></a>
<a class="sourceLine" id="cb14-36" title="36"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-37" title="37"><span class="co">#&gt; &gt; 0_node_38  (n = 2)</span></a>
<a class="sourceLine" id="cb14-38" title="38"><span class="co">#&gt; expressed above: CD3D 3.124</span></a>
<a class="sourceLine" id="cb14-39" title="39"><span class="co">#&gt; expressed below: TMSB4X 5.7</span></a>
<a class="sourceLine" id="cb14-40" title="40"><span class="co">#&gt; expressed between: NDFIP2 1.63 1.588</span></a>
<a class="sourceLine" id="cb14-41" title="41"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-42" title="42"><span class="co">#&gt; &gt; 0_node_39  (n = 8)</span></a>
<a class="sourceLine" id="cb14-43" title="43"><span class="co">#&gt; expressed above: CD3D 3.124</span></a>
<a class="sourceLine" id="cb14-44" title="44"><span class="co">#&gt; expressed below: TMSB4X 5.7</span></a>
<a class="sourceLine" id="cb14-45" title="45"><span class="co">#&gt; expressed between: NDFIP2 2.013 1.63</span></a>
<a class="sourceLine" id="cb14-46" title="46"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-47" title="47"><span class="co">#&gt; &gt; 0_node_40  (n = 2)</span></a>
<a class="sourceLine" id="cb14-48" title="48"><span class="co">#&gt; expressed above: CD3D 3.124, TMSB4X 5.7</span></a>
<a class="sourceLine" id="cb14-49" title="49"><span class="co">#&gt; expressed below: NDFIP2 2.013</span></a>
<a class="sourceLine" id="cb14-50" title="50"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-51" title="51"><span class="co">#&gt; &gt; 0_node_42  (n = 3)</span></a>
<a class="sourceLine" id="cb14-52" title="52"><span class="co">#&gt; expressed above: CD3D 3.124, NDFIP2 2.013</span></a>
<a class="sourceLine" id="cb14-53" title="53"><span class="co">#&gt; expressed below: CKB 0</span></a>
<a class="sourceLine" id="cb14-54" title="54"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-55" title="55"><span class="co">#&gt; &gt; 0_node_5   (n = 9)</span></a>
<a class="sourceLine" id="cb14-56" title="56"><span class="co">#&gt; expressed below: CD3D 1.616, CKB 4.539</span></a>
<a class="sourceLine" id="cb14-57" title="57"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-58" title="58"><span class="co">#&gt; &gt; 0_node_7   (n = 2)</span></a>
<a class="sourceLine" id="cb14-59" title="59"><span class="co">#&gt; expressed below: CKB 4.539</span></a>
<a class="sourceLine" id="cb14-60" title="60"><span class="co">#&gt; expressed between: CD3D 2.07 1.616</span></a>
<a class="sourceLine" id="cb14-61" title="61"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-62" title="62"><span class="co">#&gt; &gt; 0_node_8   (n = 3)</span></a>
<a class="sourceLine" id="cb14-63" title="63"><span class="co">#&gt; expressed below: CKB 4.539</span></a>
<a class="sourceLine" id="cb14-64" title="64"><span class="co">#&gt; expressed between: CD3D 2.749 2.07</span></a>
<a class="sourceLine" id="cb14-65" title="65"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-66" title="66"><span class="co">#&gt; &gt; 0_node_9   (n = 2)</span></a>
<a class="sourceLine" id="cb14-67" title="67"><span class="co">#&gt; expressed below: CKB 4.539</span></a>
<a class="sourceLine" id="cb14-68" title="68"><span class="co">#&gt; expressed between: CD3D 3.124 2.749</span></a>
<a class="sourceLine" id="cb14-69" title="69"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-70" title="70"><span class="co">#&gt; &gt; 1_node_16  (n = 3)</span></a>
<a class="sourceLine" id="cb14-71" title="71"><span class="co">#&gt; expressed above: CKB 5.142</span></a>
<a class="sourceLine" id="cb14-72" title="72"><span class="co">#&gt; expressed below: ARHGDIB 0, CD3D 3.124, NDFIP2 0</span></a>
<a class="sourceLine" id="cb14-73" title="73"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-74" title="74"><span class="co">#&gt; &gt; 1_node_17  (n = 2)</span></a>
<a class="sourceLine" id="cb14-75" title="75"><span class="co">#&gt; expressed above: ARHGDIB 0, CKB 4.539</span></a>
<a class="sourceLine" id="cb14-76" title="76"><span class="co">#&gt; expressed below: CD3D 3.124, NDFIP2 0</span></a>
<a class="sourceLine" id="cb14-77" title="77"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-78" title="78"><span class="co">#&gt; &gt; 1_node_22  (n = 8)</span></a>
<a class="sourceLine" id="cb14-79" title="79"><span class="co">#&gt; expressed below: CD3D 1.741</span></a>
<a class="sourceLine" id="cb14-80" title="80"><span class="co">#&gt; expressed between: CKB 4.803 4.539, NDFIP2 2.841 0</span></a>
<a class="sourceLine" id="cb14-81" title="81"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-82" title="82"><span class="co">#&gt; &gt; 1_node_25  (n = 3)</span></a>
<a class="sourceLine" id="cb14-83" title="83"><span class="co">#&gt; expressed below: CD3D 1.741</span></a>
<a class="sourceLine" id="cb14-84" title="84"><span class="co">#&gt; expressed between: CKB 4.848 4.803, NDFIP2 2.841 2.215</span></a>
<a class="sourceLine" id="cb14-85" title="85"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-86" title="86"><span class="co">#&gt; &gt; 1_node_26  (n = 27)</span></a>
<a class="sourceLine" id="cb14-87" title="87"><span class="co">#&gt; expressed above: CKB 4.848</span></a>
<a class="sourceLine" id="cb14-88" title="88"><span class="co">#&gt; expressed below: CD3D 1.741</span></a>
<a class="sourceLine" id="cb14-89" title="89"><span class="co">#&gt; expressed between: NDFIP2 2.841 0</span></a>
<a class="sourceLine" id="cb14-90" title="90"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-91" title="91"><span class="co">#&gt; &gt; 1_node_30  (n = 4)</span></a>
<a class="sourceLine" id="cb14-92" title="92"><span class="co">#&gt; expressed above: TMSB4X 0</span></a>
<a class="sourceLine" id="cb14-93" title="93"><span class="co">#&gt; expressed between: CD3D 3.124 1.741, CKB 5.031 4.539, NDFIP2 2.841 0</span></a>
<a class="sourceLine" id="cb14-94" title="94"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-95" title="95"><span class="co">#&gt; &gt; 1_node_43  (n = 5)</span></a>
<a class="sourceLine" id="cb14-96" title="96"><span class="co">#&gt; expressed above: CD3D 3.124, CKB 0, NDFIP2 2.013</span></a></code></pre></div>
<p>(note how much more complicate the model ends up being …)</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">topn_predicted_cluster &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(</a>
<a class="sourceLine" id="cb15-2" title="2">    tree_model_topn, <span class="dt">newdata =</span> <span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(testing_mix, <span class="dt">genes =</span> top_markers<span class="op">$</span>gene))</a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4">testing_mix[[<span class="st">"topn_predicted_cluster"</span>]] &lt;-<span class="st"> </span>topn_predicted_cluster</a>
<a class="sourceLine" id="cb15-5" title="5">testing_mix[[<span class="st">"topn_correctly_classified"</span>]] &lt;-<span class="st"> </span>topn_predicted_cluster <span class="op">==</span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="st">    </span><span class="kw">Idents</span>(testing_mix)</a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">confusion_tbl &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(</a>
<a class="sourceLine" id="cb16-2" title="2">    <span class="dt">Predicted =</span> topn_predicted_cluster, </a>
<a class="sourceLine" id="cb16-3" title="3">    <span class="dt">Actual =</span> <span class="kw">Idents</span>(testing_mix))</a>
<a class="sourceLine" id="cb16-4" title="4"></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="kw"><a href="../reference/autoplot.html">autoplot</a></span>(<span class="kw"><a href="../reference/as.frequency.matrix.html">as.frequency.matrix</a></span>(confusion_tbl), <span class="dt">show_number =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="evaluating_tree_quality_files/figure-html/unnamed-chunk-15-1.png" width="288"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">DimPlot</span>(testing_mix, <span class="dt">group.by =</span> <span class="st">"correctly_classified"</span>)</a></code></pre></div>
<p><img src="evaluating_tree_quality_files/figure-html/unnamed-chunk-16-1.png" width="384"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#splitting-the-dataset">Splitting the dataset</a></li>
      <li><a href="#trainning-the-classifier">Trainning the classifier</a></li>
      <li><a href="#checking-the-consistency-of-the-classifier">Checking the consistency of the classifier</a></li>
      <li><a href="#tuning-the-model">Tuning the model</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by J. Sebastian Paez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
